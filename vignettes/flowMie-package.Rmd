---
title: "Mie Theory Modeling of Cytometer Response to Extracellular Vesicles"
author: "Wade Rogers"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
# pre-load libraries
library(flowCore)
library(Rscattnlay)
library(flowMie)
library(wadeTools)
```

## Introduction
There has been a great deal of interest in recent years in Extracellular Vesicles (EVs), including exosomes and microvesicles.  There are a number of methods of detecting and characterizing EVs.  Flow cytometry is capable of multi-parameter EV detection and characterization, but not all instruments are capable of this difficult feat.

`flowMie` provides tools to describe small particles, including calibration beads as well as EVs, along with an optical description of the flow cytometer laser and detector systems, that enable a complete and accurate modeling environment to calculate and characterize the response of your flow cytometer to these very small and dim particles.

## Describe the Flow Cytometer
The first step is to describe the characteristics of the flow cytometer that affect its response to the scattering of light.  These characteristics include:

- The nominal scattering angle of the detector
- The scattering detector half-angle of acceptance with respect to the objective's focal plane
- The laser polarization

Please note that as of now the detector aperture is assumed to be round (more precisely, cylindrically symmetrical).  Oddly, the laser wavelength isn't modeled in the detector but rather in the particle (due to the organization of objects in Rscattnlay).

```{r detector, eval=TRUE, echo=TRUE}

# create a detector, 
#    - located at 90 degrees with respect to the incident laser light,
#    - with a detector half-angle of 60 degrees,
#    - laser is linearly polarized perpendicular to the plane of incidence
detector = create_detector(theta_0 = 90, beta = 60, psi_0 = 90, pol = 1.0)
```

## Describe Particles
The function `create_particle()` flexibly describes a particle characterized by:

- How many layers it has
- The radius of each layer
- the refractive index of each layer

as well as:

- the refractive index of the medium in which it's suspended
- the wavelength of the incident light

```{r scatterer, eval=TRUE, echo=TRUE}
# create a 2-layer particle
#    - the first layer has a radius of 95 nm and RI of 1.38 (the core)
#    - the second layer has a radius of 100 nm and RI of 1.46 (the membrane)
# The particle is in a fluid whose RI is 1.34, corresponding to normal saline
# The incident wavelenth is 488 (the blue laser, off which the SSC detector is located)
vesicle = create_particle(medium = 1.34, lambda = 488, n_layers = 2, r = c(95, 100), n = c(1.38, 1.46))
```

In addition to this general-purpose function there are a few convenience functions with built-in refractive indices, and which accept the size description as a diameter rather than a radius (in keeping with the way calibration beads are typically described).  These functions are simply wrappers for `create_particle()`:

```{r beads, eval=TRUE, echo=TRUE}
# a 100 nm diameter polystyrene bead in saline, illuminated by the blue laser
bead_polystyrene = create_PS(d = 100)

# a 200 nm diameter silica bead in saline, illuminated by the blue laser
bead_silica = create_SI(d = 200)

# an EV in saline, illuminated by the blue laser
ev = create_EV(d = 200)

```

## Calculate Scattering Response
Now that we've described the instrument and the particle we can perform scattering calculations.
```{r calc, eval=TRUE, echo=TRUE}
# how big is the scattering signal with our default detector due to a 200 nm diameter silica bead?
val = calculate_detector_response(particle = create_SI(d = 200), detector = create_detector())
val
```

Let's look at the size-dependence of several types of particles, with a realistic instrument, and an instrument with a very narrow acceptance half-angle:
```{r size_dep, eval=TRUE, echo=TRUE, out.width="100%", fig.height=14, fig.width=14}

# make an "instrument" with narrow acceptance angle for SSC
instr_narrow = create_detector(beta = 1)

# make an instrument that corresponds to a BD Canto
instr_canto = create_detector()

dia = seq(20, 1000, by = 5)
ssc_au   = ssc_ps   = ssc_si   = ssc_ev   = vector('numeric')
ssc_au_n = ssc_ps_n = ssc_si_n = ssc_ev_n = vector('numeric')
for (i in 1:length(dia)) {
  # gold nanoparticles.  Note the complex refractive index, characteristic of metals
  gold = create_particle(n_layers = 1, r = dia[i] / 2, n = 1.1271+1.8382i)
  ssc_au[i]   = calculate_detector_response(gold, detector = instr_canto)
  ssc_au_n[i] = calculate_detector_response(gold, detector = instr_narrow)
  
  # polystyrene
  ps = create_PS(d = dia[i])
  ssc_ps[i]   = calculate_detector_response(ps, detector = instr_canto)
  ssc_ps_n[i] = calculate_detector_response(ps, detector = instr_narrow)
  
  # silica
  si = create_SI(d = dia[i])
  ssc_si[i]   = calculate_detector_response(si, detector = instr_canto)
  ssc_si_n[i] = calculate_detector_response(si, detector = instr_narrow)
 
  # EV
  ev = create_EV(d = dia[i])
  ssc_ev[i]   = calculate_detector_response(ev, detector = instr_canto)
  ssc_ev_n[i] = calculate_detector_response(ev, detector = instr_narrow) 
}

# plot the results
par(mar = c(5, 5, 4, 1))
decades = c(1e-8, 1e1)
cex = 1.5
lwd = 2
plot(dia, ssc_au, type = 'l', log = 'y', ylim = decades, xlim = c(0, 1000),
     xlab = "Particle Diameter (nm)", ylab = "Scattering Intensity (Arb. Units)",
     yaxt = 'n', cex.axis = cex, cex.lab = cex, lwd = lwd)
axis(side = 2, at = 10^(-8:1), labels = tick.labels(-8, 1), cex.axis = cex)
lines(dia, ssc_au_n, col = 'black', lty = 'dotdash', lwd = lwd)

lines(dia, ssc_ps, col = 'indianred2', lwd = lwd)
lines(dia, ssc_ps_n, col = 'indianred2', lty = 'dotdash', lwd = lwd)

lines(dia, ssc_si, col = 'dodgerblue2', lwd = lwd)
lines(dia, ssc_si_n, col = 'dodgerblue2', lty = 'dotdash', lwd = lwd)

lines(dia, ssc_ev, col = 'springgreen4', lwd = lwd)
lines(dia, ssc_ev_n, col = 'springgreen4', lty = 'dotdash', lwd = lwd)

idx = which(dia == 200)
text(x = 200, y = ssc_au[idx], labels = "Au", col = 'black', cex = cex, pos = 3)
text(x = 200, y = ssc_ps[idx], labels = "PS", col = 'indianred2', cex = cex, pos = 3)
text(x = 200, y = ssc_si[idx], labels = "SI", col = 'dodgerblue2', cex = cex, pos = 3)
text(x = 200, y = ssc_ev[idx], labels = "EV", col = 'springgreen4', cex = cex, pos = 3)

ssc_au[idx] / ssc_ps[idx]
ssc_ps[idx] / ssc_si[idx]
ssc_si[idx] / ssc_ev[idx]
ssc_au[idx] / ssc_ev[idx]
```

There are a few things to note about this picture.  

1. First and foremost the y-axis is logarithmic and covers 10 decades of dynamic range.
1. Once the particle size drops below about 200-300 nm (or about half the wavelength of the incident light, which in this example is 488 nm), the curves become ridiculously steep.  This means that a small reduction in the particle size results in a large decrease in the signal it will generate.  This sets a pretty hard stop on the size limit of detectability in most cytometers.
1. The material of which the particle is made has a **profound** effect on the amount of light it scatters.  Gold particles (black curves) >> polystyrene (red curves) >> silica (blue curves) >> EVs (green curves).  Comparing at 200 nm diameter, 
    - gold scatters almost 10 times as much as polystyrene
    - polystyrene scatters about 5 times as much as silica
    - silica scatters almost 7 times as much as an EV
    - gold scatters an astounding 300 times as much as an EV
1. Comparing the solid versus the dot-dashed curves, we see the smoothing effect due to the large acceptance angle of real-life flow cytometers.  They're the way they are because high numerical aperture optics are generally designed in order to collect as much light as possible.  This means that the side scatter detector doesn't just measure 90 deg. scattering, but a range of +- 60 or so degrees around that 90 deg nominal angle.  The wiggles, or "Mie Resonances", are very pronounced with a narrow detector.

## The Mie Transform



